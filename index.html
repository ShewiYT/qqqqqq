<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title> NEON DB ¬∑ —Ñ–∞–π–ª–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at 30% 40%, #1a1f3a, #0a0c10 80%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            max-width: 1800px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 1.8rem;
            align-items: start;
        }

        .card {
            background: rgba(18, 22, 40, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 2rem;
            padding: 1.8rem 1.8rem 2.2rem;
            box-shadow: 0 0 18px rgba(0, 255, 255, 0.25), inset 0 0 6px rgba(0, 255, 255, 0.2);
            transition: box-shadow 0.3s ease, border-color 0.2s;
            color: #f0f4ff;
        }

        .card:hover {
            box-shadow: 0 0 30px #00ffff80, 0 0 10px #00ffff inset;
            border-color: #7fffff;
        }

        h2 {
            font-weight: 400;
            font-size: 1.8rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 1.8rem;
            text-shadow: 0 0 8px cyan, 0 0 18px cyan;
            border-bottom: 1px dashed rgba(0, 255, 255, 0.5);
            padding-bottom: 0.7rem;
        }

        .form-group {
            margin-bottom: 1.4rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0c0ff;
            margin-left: 0.3rem;
        }

        input, .radio-group {
            background: rgba(8, 12, 25, 0.7);
            border: 1.5px solid #2c3a70;
            border-radius: 40px;
            padding: 0.8rem 1.4rem;
            font-size: 1rem;
            color: #ffffff;
            outline: none;
            transition: all 0.2s;
            box-shadow: 0 0 5px #00a0ff40;
        }

        input:focus {
            border-color: #00ffff;
            box-shadow: 0 0 20px #00ffff, inset 0 0 5px #ffffff40;
            background: #0b1022;
        }

        .radio-group {
            display: flex;
            gap: 2rem;
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0.4rem 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            cursor: pointer;
            font-size: 1.1rem;
            background: rgba(0, 255, 255, 0.08);
            padding: 0.4rem 1.2rem;
            border-radius: 40px;
            border: 1px solid #00b8b8;
            transition: 0.2s;
        }

        .radio-option input[type="radio"] {
            appearance: none;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid #0ff;
            border-radius: 50%;
            background: transparent;
            transition: 0.15s;
        }
        .radio-option input[type="radio"]:checked {
            background: #0ff;
            box-shadow: 0 0 15px cyan;
            border: 2px solid white;
        }
        .radio-option:has(input:checked) {
            background: rgba(0, 255, 255, 0.25);
            border-color: cyan;
            box-shadow: 0 0 18px cyan;
        }

        .conditional-field {
            transition: opacity 0.3s ease;
        }
        .conditional-field.hidden {
            display: none;
        }

        .calculate-btn {
            background: linear-gradient(145deg, #ff3eb5, #7700ff);
            border: none;
            border-radius: 60px;
            padding: 1rem 2rem;
            width: 100%;
            font-size: 1.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #fff;
            text-shadow: 0 0 6px #ffb0fd;
            box-shadow: 0 0 30px #ff3eb5, 0 0 10px #a555ff;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ffffff80;
        }

        .calculate-btn:hover {
            box-shadow: 0 0 60px #ff80d0, 0 0 20px #b266ff;
            transform: scale(1.02);
        }

        /* –ø—Ä–∞–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */
        .result-block {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .distr-label {
            font-size: 0.9rem;
            color: #b0d0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .distr-sum {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 0 12px #00ffbf;
            color: #ccffff;
            margin-bottom: 0.75rem;
        }

        .result-line {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            border-bottom: 1px dashed rgba(0, 255, 255, 0.3);
            padding: 0.5rem 0.2rem;
            font-size: 1.1rem;
        }

        .role-value {
            font-weight: 800;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }

        .worker .role-value { color: #7df9ff; text-shadow: 0 0 8px #0ff; }
        .chatter .role-value { color: #ffb77c; text-shadow: 0 0 8px #ff9900; }
        .helper .role-value { color: #a0ff9e; text-shadow: 0 0 8px #00ff80; }
        .newton .role-value { color: #ff99f0; text-shadow: 0 0 8px #ff44cc; }
        .megafrishka .role-value { color: #c397ff; text-shadow: 0 0 8px #b266ff; }

        .meta-line {
            display: flex;
            gap: 0.8rem;
            margin-top: 0.8rem;
            background: rgba(0, 255, 255, 0.05);
            padding: 0.7rem 1rem;
            border-radius: 3rem;
            border: 1px solid #00b8b8;
            font-size: 0.95rem;
            word-break: break-word;
        }

        /* —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö */
        .db-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            background: #0f142aa0;
            padding: 0.7rem 1.5rem;
            border-radius: 60px;
            border: 1px solid #ff66cc;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .db-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .db-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0f0;
            box-shadow: 0 0 12px #0f0;
        }
        .db-led.off {
            background: #ff4444;
            box-shadow: 0 0 12px #f00;
        }

        .history-section {
            margin-top: 2rem;
            border-top: 2px solid #00ffff60;
            padding-top: 1.5rem;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .history-title {
            font-size: 1.4rem;
            text-shadow: 0 0 8px cyan;
            letter-spacing: 2px;
        }

        .export-btn {
            background: transparent;
            border: 2px solid #ff66cc;
            color: #ffccff;
            padding: 0.6rem 1.8rem;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 0 12px #ff44aa;
            font-size: 0.95rem;
        }
        .export-btn:hover {
            background: #ff44aa30;
            box-shadow: 0 0 25px #ff80d0;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: #030617b0;
            border-radius: 1.5rem;
            overflow: hidden;
            border: 1px solid #00ffff60;
            backdrop-filter: blur(4px);
            font-size: 0.8rem;
        }

        .history-table th {
            background: #0f1a3a;
            color: #9ff;
            font-weight: 500;
            text-transform: uppercase;
            padding: 0.8rem 0.3rem;
            border-bottom: 2px solid cyan;
        }

        .history-table td {
            padding: 0.7rem 0.4rem;
            border-bottom: 1px solid #33ffff30;
            color: #cef;
            text-align: center;
        }

        .status-badge {
            padding: 0.2rem 0.8rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            cursor: pointer;
            background: #2a2f5a;
            border: 1px solid;
            transition: 0.1s;
            display: inline-block;
        }
        .status-pending { background: #5a4a2a; border-color: #ffaa33; color: #ffd966; }
        .status-paid { background: #1e4a2a; border-color: #33ff99; color: #a0ffb0; }
        .status-processing { background: #3a2f6a; border-color: #aa88ff; color: #ccbbff; }

        .footnote {
            font-size: 0.8rem;
            color: #aab5e0;
            margin-top: 1.2rem;
            text-align: right;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –õ–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: —Ñ–æ—Ä–º–∞ -->
        <div class="card">
            <h2>‚ü£ –í–í–û–î –î–ê–ù–ù–´–• ‚ü¢</h2>
            <div class="form-group">
                <label>üìá ID –ª–æ–≥–∞</label>
                <input type="text" id="logId" placeholder="log-2025-02-18" value="log-42">
            </div>
            <div class="form-group">
                <label>üÜî Discord –≤–æ—Ä–∫–µ—Ä–∞</label>
                <input type="text" id="workerDiscord" placeholder="@worker" value="cyber_igor">
            </div>
            <div class="form-group">
                <label>üí∞ –°—É–º–º–∞ –ø–æ —Å—Ç–∏–º ($)</label>
                <input type="number" id="steamAmount" placeholder="0" value="300" step="0.01">
            </div>
            <div class="form-group">
                <label>üíµ –°—É–º–º–∞ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è ($)</label>
                <input type="number" id="receivedAmount" placeholder="0.00" value="285.00" step="0.01">
            </div>

            <!-- –±—ã–ª –ª–∏ —á–∞—Ç–µ—Ä? -->
            <div class="form-group">
                <label>üë• –ë—ã–ª –ª–∏ —á–∞—Ç–µ—Ä?</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="chatterToggle" value="yes" id="chatterYes"> –î–ê
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="chatterToggle" value="no" id="chatterNo" checked> –ù–ï–¢
                    </label>
                </div>
            </div>

            <!-- –Ω–∏–∫ —á–∞—Ç–µ—Ä–∞ -->
            <div id="chatter-field" class="form-group conditional-field hidden">
                <label>üé§ –ù–∏–∫ —á–∞—Ç–µ—Ä–∞</label>
                <input type="text" id="chatterNick" placeholder="chatter_nick" value="neon_sky">
            </div>

            <div class="form-group">
                <label>üõ†Ô∏è –•–µ–ª–ø–µ—Ä (–Ω–∏–∫)</label>
                <input type="text" id="helperNick" placeholder="helper_username" value="cyber_helper">
            </div>
            <div class="form-group">
                <label>üí≥ –ö–æ—à–µ–ª–µ–∫ TRC20 (–≤–æ—Ä–∫–µ—Ä–∞)</label>
                <input type="text" id="trc20" placeholder="TXYZ... (USDT)" value="TXneonAbc123...xyz">
            </div>

            <button class="calculate-btn" id="calcBtn">‚ü£ –†–ê–°–°–ß–ò–¢–ê–¢–¨ ‚ü¢</button>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã + –∏—Å—Ç–æ—Ä–∏—è —Å –ë–î -->
        <div class="card" id="resultCard">
            <h2>‚ü£ –í–´–ü–õ–ê–¢–´ / –ë–î ‚ü¢</h2>
            
            <!-- —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
            <div class="db-status" id="dbStatus">
                <div class="db-indicator">
                    <span class="db-led" id="dbLed"></span>
                    <span id="dbStatusText">—Ñ–∞–π–ª–æ–≤–∞—è –ë–î: data.json</span>
                </div>
                <button class="export-btn" id="refreshBtn" style="padding:0.3rem 1rem;">üîÑ –°–ò–ù–•–†.</button>
            </div>

            <!-- –¢–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç -->
            <div class="distr-label">–±–∞–∑–∞ 95% –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ</div>
            <div class="distr-sum" id="distrBase">0.00 $</div>
            <div class="distr-label">–º–∏–Ω—É—Å 5% —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º 90%</div>
            <div class="distr-sum" id="distrFinal" style="font-size: 2rem; color: #f9c;">0.00 $</div>

            <div id="dynamicResults" style="margin-top: 1rem;"></div>

            <div class="meta-line">
                <span class="meta-label">üìã ID –õ–æ–≥–∞:</span>
                <span class="meta-value" id="displayLogId">‚Äî</span>
            </div>
            <div class="meta-line trc20">
                <span class="meta-label">üí≥ TRC20:</span>
                <span class="meta-value" id="displayTrc">‚Äî</span>
            </div>

            <!-- –ò—Å—Ç–æ—Ä–∏—è —Å –ë–î -->
            <div class="history-section">
                <div class="history-header">
                    <span class="history-title">‚ü£ –ò–°–¢–û–†–ò–Ø –ò–ó –§–ê–ô–õ–ê ‚ü¢</span>
                    <button class="export-btn" id="exportExcelBtn">üì• EXCEL</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="history-table" id="historyTable">
                        <thead>
                            <tr>
                                <th>ID –ª–æ–≥–∞</th>
                                <th>–í–æ—Ä–∫–µ—Ä</th>
                                <th>–ö–æ—à–µ–ª–µ–∫</th>
                                <th>–ß–∞—Ç–µ—Ä</th>
                                <th>–•–µ–ª–ø–µ—Ä</th>
                                <th>Newton</th>
                                <th>Megafrishka</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="9" style="text-align:center; padding:2rem;">‚è≥ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="footnote">‚úß –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ data.json (—Ñ–∞–π–ª–æ–≤–∞—è –ë–î)</div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        (function() {
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –±—ç–∫–µ–Ω–¥–∞
            const CONFIG = {
                // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º JSON Server –∏–ª–∏ —Ñ–µ–π–∫–æ–≤—ã–π API
                // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL –±—ç–∫–µ–Ω–¥–∞
                API_URL: 'http://x.elita313.beget.tech/api.php', // –ø—Ä–∏–º–µ—Ä JSONbin (–∑–∞–º–µ–Ω–∏—Ç–µ!)
                USE_MOCK: false // –ø–æ–∫–∞ –Ω–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage + –º–æ–∫
            };

            // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            const logIdInput = document.getElementById('logId');
            const workerInput = document.getElementById('workerDiscord');
            const receivedInput = document.getElementById('receivedAmount');
            const chatterYes = document.getElementById('chatterYes');
            const chatterNo = document.getElementById('chatterNo');
            const chatterField = document.getElementById('chatter-field');
            const chatterNickInput = document.getElementById('chatterNick');
            const helperInput = document.getElementById('helperNick');
            const trcInput = document.getElementById('trc20');

            const distrBaseSpan = document.getElementById('distrBase');
            const distrFinalSpan = document.getElementById('distrFinal');
            const dynamicResults = document.getElementById('dynamicResults');
            const displayLogId = document.getElementById('displayLogId');
            const displayTrc = document.getElementById('displayTrc');
            const historyBody = document.getElementById('historyBody');
            const calcBtn = document.getElementById('calcBtn');
            const exportBtn = document.getElementById('exportExcelBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const dbLed = document.getElementById('dbLed');
            const dbStatusText = document.getElementById('dbStatusText');

            // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö
            let historyData = [];

            // ---- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–º —á–∞—Ç–µ—Ä–∞ ----
            function toggleChatterField() {
                if (chatterYes.checked) {
                    chatterField.classList.remove('hidden');
                } else {
                    chatterField.classList.add('hidden');
                }
            }
            chatterYes.addEventListener('change', toggleChatterField);
            chatterNo.addEventListener('change', toggleChatterField);
            toggleChatterField();

            // ---- —Ñ–æ—Ä–º–∞—Ç –¥–µ–Ω–µ–≥ ----
            const formatUSD = (val) => val.toFixed(2) + ' $';

            // ---- –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ë–î ----
            function setDBStatus(online, message) {
                if (online) {
                    dbLed.className = 'db-led';
                    dbStatusText.innerText = message || '–ë–î –ø–æ–¥–∫–ª—é—á–µ–Ω–∞';
                } else {
                    dbLed.className = 'db-led off';
                    dbStatusText.innerText = message || '–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ';
                }
            }

            // ---- –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ----
            async function loadFromDatabase() {
                try {
                    setDBStatus(false, '–∑–∞–≥—Ä—É–∑–∫–∞...');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ JSONbin (–∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ API)
                    if (!CONFIG.USE_MOCK) {
                        const response = await axios.get(CONFIG.API_URL, {
                            headers: {
                                'X-Master-Key': CONFIG.API_KEY
                            }
                        });
                        historyData = response.data.record || [];
                        setDBStatus(true, '–ë–î –æ–Ω–ª–∞–π–Ω');
                    } else {
                        // –ú–æ–∫-—Ä–µ–∂–∏–º - –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –∫–∞–∫ –æ–±—â—É—é –ë–î
                        const localData = localStorage.getItem('neon_payouts_db');
                        if (localData) {
                            historyData = JSON.parse(localData);
                        } else {
                            // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                            historyData = [
                                {
                                    logId: 'log-40',
                                    worker: 'mike_core',
                                    workerAmount: '112.50 $',
                                    wallet: 'TXYZdemo111...',
                                    chatter: 'luna',
                                    chatterAmount: '28.12 $',
                                    helper: 'alex',
                                    helperAmount: '16.87 $',
                                    newtonAmount: '28.12 $',
                                    megafrishkaAmount: '28.12 $',
                                    totalDistr: '213.75 $',
                                    status: '–≤—ã–ø–ª–∞—á–µ–Ω–æ'
                                },
                                {
                                    logId: 'log-39',
                                    worker: 'neo_driver',
                                    workerAmount: '152.00 $',
                                    wallet: 'TXYZdemo222...',
                                    chatter: null,
                                    chatterAmount: '',
                                    helper: 'sam',
                                    helperAmount: '22.80 $',
                                    newtonAmount: '38.00 $',
                                    megafrishkaAmount: '38.00 $',
                                    totalDistr: '288.80 $',
                                    status: '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ'
                                }
                            ];
                            localStorage.setItem('neon_payouts_db', JSON.stringify(historyData));
                        }
                        setDBStatus(false, '–ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î (–æ–±—â–∞—è)');
                    }
                    
                    renderHistory();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î:', error);
                    setDBStatus(false, '–æ—à–∏–±–∫–∞, –ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î');
                    
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ localStorage
                    const localData = localStorage.getItem('neon_payouts_db');
                    if (localData) {
                        historyData = JSON.parse(localData);
                    }
                    renderHistory();
                }
            }

            // ---- —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ----
            async function saveToDatabase() {
                try {
                    if (!CONFIG.USE_MOCK) {
                        await axios.put(CONFIG.API_URL, historyData, {
                            headers: {
                                'X-Master-Key': CONFIG.API_KEY,
                                'Content-Type': 'application/json'
                            }
                        });
                        setDBStatus(true, '–ë–î –æ–Ω–ª–∞–π–Ω');
                    } else {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                        localStorage.setItem('neon_payouts_db', JSON.stringify(historyData));
                        setDBStatus(false, '–ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î:', error);
                    setDBStatus(false, '–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            }

            // ---- —Ä–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ ----
            function renderHistory() {
                if (historyData.length === 0) {
                    historyBody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:2rem;">üì≠ –∏—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>';
                    return;
                }
                
                let html = '';
                // –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–≤–µ—Ä—Ö—É
                historyData.slice().reverse().forEach((entry, idx) => {
                    const statusClass = 
                        entry.status === '–≤—ã–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 
                        entry.status === '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ' ? 'status-processing' : 'status-pending';
                    
                    html += `<tr>
                        <td>${entry.logId}</td>
                        <td>${entry.worker} ${entry.workerAmount || ''}</td>
                        <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis;">${entry.wallet || '‚Äî'}</td>
                        <td>${entry.chatter ? entry.chatter + ' ' + (entry.chatterAmount || '') : '‚Äî'}</td>
                        <td>${entry.helper} ${entry.helperAmount || ''}</td>
                        <td>${entry.newtonAmount || ''}</td>
                        <td>${entry.megafrishkaAmount || ''}</td>
                        <td>${entry.totalDistr || ''}</td>
                        <td>
                            <span class="status-badge ${statusClass}" data-idx="${historyData.length - 1 - idx}">
                                ${entry.status || '–æ–∂–∏–¥–∞–µ—Ç'}
                            </span>
                        </td>
                    </tr>`;
                });
                historyBody.innerHTML = html;

                // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
                document.querySelectorAll('.status-badge').forEach(badge => {
                    badge.addEventListener('click', async function(e) {
                        const idx = this.dataset.idx;
                        if (idx !== undefined) {
                            const current = historyData[idx];
                            const nextStatus = 
                                current.status === '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã' ? '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ' :
                                current.status === '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ' ? '–≤—ã–ø–ª–∞—á–µ–Ω–æ' : '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã';
                            historyData[idx].status = nextStatus;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                            await saveToDatabase();
                            renderHistory();
                        }
                    });
                });
            }

            // ---- –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é ----
            async function addCurrentToHistory() {
                const logId = logIdInput.value.trim() || '‚Äî';
                const worker = workerInput.value.trim() || '–≤–æ—Ä–∫–µ—Ä';
                const wallet = trcInput.value.trim() || '‚Äî';
                const chatter = chatterYes.checked ? (chatterNickInput.value.trim() || '—á–∞—Ç–µ—Ä') : null;
                const helper = helperInput.value.trim() || '—Ö–µ–ª–ø–µ—Ä';
                const received = parseFloat(receivedInput.value) || 0;

                // —Ä–∞—Å—á—ë—Ç
                const base = received * 0.95;
                const finalDistr = base * 0.90;
                
                const hasChatter = chatterYes.checked;
                let workerPercent = hasChatter ? 65 : 80;
                let chatterPercent = hasChatter ? 15 : 0;
                const helperPercent = 3;
                const remainingPercent = 17;
                
                const workerPart = finalDistr * (workerPercent / 100);
                const chatterPart = hasChatter ? finalDistr * (chatterPercent / 100) : 0;
                const helperPart = finalDistr * (helperPercent / 100);
                const newtonPart = finalDistr * (remainingPercent / 2 / 100);
                const megafrishkaPart = finalDistr * (remainingPercent / 2 / 100);

                // —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å
                const newEntry = {
                    logId: logId,
                    worker: worker,
                    workerAmount: formatUSD(workerPart),
                    wallet: wallet,
                    chatter: hasChatter ? (chatterNickInput.value.trim() || '—á–∞—Ç–µ—Ä') : null,
                    chatterAmount: hasChatter ? formatUSD(chatterPart) : '',
                    helper: helper,
                    helperAmount: formatUSD(helperPart),
                    newtonAmount: formatUSD(newtonPart),
                    megafrishkaAmount: formatUSD(megafrishkaPart),
                    totalDistr: formatUSD(finalDistr),
                    status: '–æ–∂–∏–¥–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—ã',
                    timestamp: new Date().toISOString()
                };

                historyData.push(newEntry);
                await saveToDatabase();
                renderHistory();
            }

            // ---- –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Å—á—ë—Ç ----
            function calculateAndDisplay() {
                const logId = logIdInput.value.trim() || '‚Äî';
                const workerNick = workerInput.value.trim() || '–≤–æ—Ä–∫–µ—Ä';
                const helperNick = helperInput.value.trim() || '—Ö–µ–ª–ø–µ—Ä';
                const chatterNick = chatterNickInput.value.trim() || '—á–∞—Ç–µ—Ä';
                const trc = trcInput.value.trim() || '‚Äî';
                const received = parseFloat(receivedInput.value) || 0;

                const hasChatter = chatterYes.checked;

                const base = received * 0.95;
                const finalDistr = base * 0.90;

                let workerPercent = hasChatter ? 65 : 80;
                let chatterPercent = hasChatter ? 15 : 0;
                const helperPercent = 3;
                const remainingPercent = 17;

                const workerPart = finalDistr * (workerPercent / 100);
                const chatterPart = hasChatter ? finalDistr * (chatterPercent / 100) : 0;
                const helperPart = finalDistr * (helperPercent / 100);
                const newtonPart = finalDistr * (remainingPercent / 2 / 100);
                const megafrishkaPart = finalDistr * (remainingPercent / 2 / 100);

                distrBaseSpan.innerText = formatUSD(base);
                distrFinalSpan.innerText = formatUSD(finalDistr);

                let html = '';
                html += `<div class="result-line worker"><span class="role-icon">üë§ –í–æ—Ä–∫–µ—Ä [${workerNick}]</span><span class="role-value">${formatUSD(workerPart)}</span></div>`;
                if (hasChatter) {
                    html += `<div class="result-line chatter"><span class="role-icon">üó£Ô∏è –ß–∞—Ç–µ—Ä [${chatterNick}]</span><span class="role-value">${formatUSD(chatterPart)}</span></div>`;
                }
                html += `<div class="result-line helper"><span class="role-icon">üõ†Ô∏è –•–µ–ª–ø–µ—Ä [${helperNick}]</span><span class="role-value">${formatUSD(helperPart)}</span></div>`;
                html += `<div class="result-line newton"><span class="role-icon">üíé Newton</span><span class="role-value">${formatUSD(newtonPart)}</span></div>`;
                html += `<div class="result-line megafrishka"><span class="role-icon">üíé Megafrishka</span><span class="role-value">${formatUSD(megafrishkaPart)}</span></div>`;
                dynamicResults.innerHTML = html;

                displayLogId.innerText = logId;
                displayTrc.innerText = trc;

                // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                addCurrentToHistory();
            }

            // ---- —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel ----
            function exportToExcel() {
                if (historyData.length === 0) {
                    alert('–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞');
                    return;
                }

                const headers = ['ID –ª–æ–≥–∞', '–í–æ—Ä–∫–µ—Ä (—Å—É–º–º–∞)', '–ö–æ—à–µ–ª–µ–∫ TRC20', '–ß–∞—Ç–µ—Ä (—Å—É–º–º–∞)', '–•–µ–ª–ø–µ—Ä (—Å—É–º–º–∞)', 'Newton', 'Megafrishka', '–í—Å–µ–≥–æ', '–°—Ç–∞—Ç—É—Å'];
                const rows = [];

                historyData.slice().reverse().forEach(e => {
                    rows.push([
                        e.logId,
                        `${e.worker} ${e.workerAmount || ''}`,
                        e.wallet || '‚Äî',
                        e.chatter ? `${e.chatter} ${e.chatterAmount || ''}` : '‚Äî',
                        `${e.helper} ${e.helperAmount || ''}`,
                        e.newtonAmount || '',
                        e.megafrishkaAmount || '',
                        e.totalDistr || '',
                        e.status || '–æ–∂–∏–¥–∞–µ—Ç'
                    ]);
                });

                let csvContent = headers.join('\t') + '\n';
                rows.forEach(row => {
                    csvContent += row.join('\t') + '\n';
                });

                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'neon_payouts.xls';
                link.click();
            }

            // ---- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ----
            calcBtn.addEventListener('click', (e) => {
                e.preventDefault();
                calculateAndDisplay();
            });

            exportBtn.addEventListener('click', exportToExcel);
            refreshBtn.addEventListener('click', loadFromDatabase);

            // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadFromDatabase();

            // –¥–ª—è —Ç–µ—Å—Ç–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            window.addEventListener('load', () => {
                // –Ω–µ–±–æ–ª—å—à–æ–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                setTimeout(() => {
                    calculateAndDisplay();
                }, 200);
            });
        })();
    </script>
</body>
</html>
